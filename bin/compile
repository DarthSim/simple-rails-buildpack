#!/bin/sh

cache_dir=$2

ruby_version=${RUBY_VERSION:-"2.3.4"}
vendor_url=${RUBY_VENDOR_URL:-"https://s3-external-1.amazonaws.com/heroku-buildpack-ruby/cedar-14"}

ruby_url="$vendor_url/ruby-$ruby_version.tgz"

arch_filename="ruby-$ruby_version.tgz"
arch_cache_path="$2/$arch_filename"

bundle_path="$cache_dir/bundler"
bundle_binstubs_path="$bundle_path/bin"

if [ ! -e "$file" ]; then
  echo "Download ruby $ruby_version..."
  wget "$ruby_url" -O "$arch_cache_path"
else
  echo "Ruby $ruby_version was cached before."
fi

echo "Unpacking ruby..."
tar zxf "$arch_cache_path"

echo "bundle install..."
mkdir -p bundle_binstubs_path
bundle install --without development:test --path "$bundle_path" --binstubs "$bundle_binstubs_path" -j4 --deployment

echo "Assets compilation..."
bundle exec rake assets:precompile
